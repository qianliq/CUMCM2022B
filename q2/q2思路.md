# 锥形编队优化算法思路解析

## 1. 问题背景

### 1.1 问题描述
- **目标**：优化锥形编队中15架无人机的位置，使其尽可能接近理想编队
- **约束**：每次迭代只能调度3架无人机作为参考点，其他无人机基于这3架进行位置调整
- **挑战**：在有位置偏差的情况下，找到最优的三机调度组合和位置调整策略

### 1.2 编队结构
标准锥形编队采用分层结构：
```
层次4:     11(0,4)
层次3:  7(1,3)  12(0,2)  10(1,-3)
层次2:  4(2,2)  5(2,0)  6(2,-2)
层次1:  2(3,1)  13(0,0)  3(3,-1)
层次0:     1(4,0)
层次-1: 8(1,1)  14(0,-2)  9(1,-1)
层次-2:    15(0,-4)
```

## 2. 核心算法思路

### 2.1 整体框架
1. **组合筛选**：从14架需调度飞机中选择3架作为参考
2. **位置优化**：基于三角定位原理计算其他飞机的最优位置
3. **迭代改进**：重复上述过程直到收敛
4. **最优选择**：每轮迭代选择总误差最小的组合

### 2.2 三角定位原理
对于需要调整位置的飞机M：
1. 已知3个参考点A、B、C的理想位置和实际位置
2. 已知M到A、B、C的角度关系
3. 通过几何约束求解M的最优位置

### 2.3 数学模型

#### 2.3.1 角度约束
```
α_A = ∠AMO  (M到A和原点O的夹角)
α_B = ∠BMO  (M到B和原点O的夹角)  
α_C = ∠CMO  (M到C和原点O的夹角)
```

#### 2.3.2 直线方程
过点M和A的直线：`a₁x + b₁y + c₁ = 0`
过点M和B的直线：`a₂x + b₂y + c₂ = 0`
过点M和C的直线：`a₃x + b₃y + c₃ = 0`

#### 2.3.3 优化目标
最小化角度误差：
```
minimize: Σ|∠(X,O,Pᵢ) - αᵢ|
```
其中X是待求位置，Pᵢ是第i个参考点的理想位置

## 3. 算法详细步骤

### 3.1 预处理阶段
```python
# 1. 定义标准编队位置
std_positions = [[4,0], [3,1], [3,-1], ...]

# 2. 排除不可行组合
no_need_combinations = [[1,2,3], [1,4,6], ...]

# 3. 生成有效三机组合
valid_combinations = filter_valid_combinations()
```

### 3.2 单次迭代流程
```python
for each_combination in valid_combinations:
    for each_plane in planes_to_adjust:
        # 1. 构建约束方程
        build_constraint_equations()
        
        # 2. 求解候选位置
        candidate_positions = solve_intersections()
        
        # 3. 评估误差并选择最优
        best_position = minimize_angle_error()
        
        # 4. 计算移动向量
        movement = calculate_movement_vector()
        
        # 5. 更新飞机位置
        update_position(movement)
    
    # 计算本组合的总误差
    total_error = sum(position_errors)

# 选择误差最小的组合
best_combination = min(total_errors)
```

### 3.3 位置优化的几何方法

#### 3.3.1 直线求交
```python
def solve_line_intersect(line1, line2):
    # line1: a₁x + b₁y + c₁ = 0
    # line2: a₂x + b₂y + c₂ = 0
    # 解: x = (b₁c₂ - b₂c₁)/(a₁b₂ - a₂b₁)
    #     y = (a₂c₁ - a₁c₂)/(a₁b₂ - a₂b₁)
```

#### 3.3.2 角度误差计算
```python
def cos_error(position, std_points, target_angles):
    error = 0
    for i, (std_point, target_angle) in enumerate(zip(std_points, target_angles)):
        current_angle = calculate_angle(position, std_point, origin)
        error += abs(current_angle - target_angle)
    return error
```

## 4. 关键技术点

### 4.1 组合筛选策略
- **排除机制**：预先排除已知不可行的三机组合
- **全搜索**：对所有可行组合进行评估
- **最优选择**：基于总误差最小原则选择

### 4.2 位置求解方法
- **多候选点**：计算三条直线的三个交点
- **重心法**：将交点的重心作为附加候选
- **误差评估**：对所有候选点计算角度误差
- **最优选择**：选择误差最小的位置

### 4.3 移动控制策略
```python
# 移动向量计算
target_position = ideal_positions[plane_id]
current_position = current_positions[plane_id] 
optimal_position = calculated_optimal_position

movement_vector = target_position - optimal_position
controlled_movement = lambda_factor * movement_vector

# 位置更新（非调度飞机）
if plane_id not in reference_combination:
    new_position = current_position + controlled_movement
```

### 4.4 收敛性保证
- **步长控制**：使用λ因子控制移动步长
- **误差监控**：跟踪每轮迭代的误差变化
- **最大迭代**：设置迭代上限防止无限循环

## 5. 算法优势

### 5.1 全局优化
- 每轮迭代考虑所有可能的三机组合
- 选择全局最优而非局部最优解

### 5.2 几何约束
- 基于严格的几何关系进行位置计算
- 保证解的物理意义和几何合理性

### 5.3 自适应调整
- 根据当前误差状态选择最优调度组合
- 动态调整移动策略

### 5.4 鲁棒性强
- 对初始位置偏差有良好的适应性
- 多候选点策略提高解的稳定性

## 6. 参数设置说明

### 6.1 关键参数
```python
sigma = 50          # 标准间距
new_sigma = 45      # 目标间距  
lambda_factor = [1, 1]  # 移动步长控制
max_iterations = 50     # 最大迭代次数
noise_ratio = 0.1       # 初始偏差比例
```

### 6.2 坐标变换
```python
one_x = sqrt(3)/2   # x方向单位向量
one_y = 1/2         # y方向单位向量
```

## 7. 应用场景

### 7.1 适用情况
- 锥形或层次化编队结构
- 需要基于部分参考点调整整体编队
- 对精度要求较高的编队控制

### 7.2 扩展可能
- 可扩展到三维空间
- 可适应不同的编队几何形状
- 可集成到实时控制系统

## 8. 实现细节

### 8.1 数值稳定性
- 使用数值方法处理奇异情况
- 角度计算中使用clip防止域错误
- 交点求解时检查平行线情况

### 8.2 性能优化
- 向量化操作减少循环
- 预计算常用几何量
- 合理的数据结构设计

这个算法将复杂的编队优化问题转化为几何约束优化问题，通过迭代搜索找到最优的调度组合和位置调整策略，实现了高精度的编队控制。
